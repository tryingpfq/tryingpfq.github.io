---
layout:     post
title:      Java虚拟机加载class类
subtitle:   Java虚拟机加载class类的过程是怎样的呢？
date:       2019-02-15
author:     tryingpfq
header-img: img/post-load-class2.jpg
catalog: true
tags:
    - JVM
---

## 前言
我们知道Java的类型可以分为两类：基本类型和引用类型，基本类型是由Java虚拟机预先定义好的，而另一种类型又可以分为四种：
类、接口、数组类和泛型参数，由于泛型参数会在编译过程被擦除（见后续），因此Java虚拟机实际上只有前三种。从class到内存中的类，
都需要经过加载、链接和初始化三大步骤。

### 加载
加载，是指查找字节流，并且据此创建类的过程。对于数组来说，它并没有对应的字节流，而是又Java
虚拟机直接生成的。对于其他类来说，Java虚拟机则需要借助类加载器来完成查找字节流过程。

启动类加载器是由C++实现的，没有对应的Java对象，因此在Java中只能用null来指代。处理启动类加载器
之外，其他的类加载器都是Java.lang.ClassLoader的子类，因此有对应的Java对象。这些类加载器
需要先由另一个类加载器，比如启动类加载器，加载至Java虚拟机中，方能执行类加载。

在Java虚拟机中，每当一个类加载器接收到加载请求时，它会先将请求转发给父类加载器。只有在父类加载器没有
找到所请求的类的情况下，该类加载器才会尝试去加载。

在Java9之前，启动类加载器负责加载最为基础、最为重要的类，比如存放在JRE的离别目录下jar
包中的类。

### 链接
链接，是指将创建成的类合并至Java虚拟机，使之能够执行的过程。分为验证、准备、解析
三个阶段。

#### 验证
验证的目的在于确保被加载类能够满足Java虚拟机的约束条件。Java编译器生成的类文件必然满足
Java虚拟机的约束条件。

#### 准备
准备阶段目的，是为了被加载类的静态字段分配内存。Java代码中对静态字段的具体初始化，则会在
稍后的初始化阶段中进行。

在class文件被加载至Java虚拟机之前，这个类无法知道知道其他类及方法、字段所对应的具体地址
、甚至不知道自己方法、字段的地址。因此，每当需要引用这些成员时，Java编译器会生成一个符号引用，。


#### 解析
解析阶段，正是将这些符号引用解析成为实际引用。如果符合引用指定一个未被加载的类，或者
。

注意：Java虚拟机规范并没有要求在链接过程完成初始化，仅规定，如果某些字节码使用了符号
引用，那么在执行这些字节码之前，需要完成这些符号引用解析。

### 初始化
在Java代码中，如果要初始化一个静态字段，我们可以在声明时直接赋值，也可以在静态
代码块中对其赋值。类加载器的最后一步是初始化，便是为了标记为常量的字段赋值，以及执行<clinit>方法的过程。Java虚拟机会通过加锁来确保类的<clinit>方法仅被执行一次。只有初始化
完成之后，类才正式成为可执行的状态。


### 类的初始化合适会被触发呢？
 * 1：当虚拟机启动时，初始化用户指定的主类。
 * 2：当遇到用以新建目标类实例的 new 指令时，初始化 new 指定的目标类。
 * 3：当遇到调用静态方法的指令，初始化该静态方法所在的类。
 * 4：当遇到调用静态字段的指令，初始化该静态字段所在的类。
 * 5：子类的初始会触发父类的初始化。
 * 6：如果一个借口定义了default方法，那么直接实现或者间接实现该接口的类的初始化，会触发该接口的初始化。
 * 7：使用反射API对某个类进行反射调用时，初始化这个类。
 * 8：当初次调用MethodHandle实类时，初始化MethodHandle指向的方法所在的类。


参考[极客时间](https://time.geekbang.org/column/108)
